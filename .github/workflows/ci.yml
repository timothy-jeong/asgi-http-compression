name: CI

on:
    push:
        branches: [main]
        tags:
            - "v*"
    pull_request:
        branches: [main]
    workflow_dispatch:

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                # 점을 뺀 버전 이름으로 매트릭스를 구성하면 tox 환경과 일치시키기 편합니다.
                python:
                    [
                        { version: "3.10", env: "py310" },
                        { version: "3.11", env: "py311" },
                        { version: "3.12", env: "py312" },
                        { version: "3.13", env: "py313" },
                        { version: "3.14", env: "py314" },
                    ]
                include:
                    - python: { version: "3.13", env: "lint" }

        steps:
            - uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  enable-cache: true
                  python-version: ${{ matrix.python.version }}

            - name: Run tox
              run: |
                  uv run --extra test tox -e ${{ matrix.python.env }}

    publish:
        runs-on: ubuntu-latest
        needs: test
        if: github.event_name == 'push' && github.ref_type == 'tag' && startsWith(github.ref_name, 'v')
        permissions:
            contents: write
            id-token: write

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  enable-cache: true
                  python-version: "3.12"

            - name: Extract version from pyproject.toml
              id: version
              run: |
                  python << 'EOF'
                  import re
                  import os

                  # Read version from pyproject.toml
                  with open('pyproject.toml', 'r') as f:
                      content = f.read()
                      match = re.search(r'^version\s*=\s*["\']([^"\']+)["\']', content, re.MULTILINE)
                      if match:
                          version = match.group(1)
                      else:
                          # Fallback: extract from tag if available
                          ref = os.environ.get('GITHUB_REF_NAME', '')
                          if ref.startswith('v'):
                              version = ref[1:]
                          else:
                              version = ref

                  # Write to GITHUB_OUTPUT
                  output_file = os.environ.get('GITHUB_OUTPUT')
                  with open(output_file, 'a') as f:
                      f.write(f"version={version}\n")
                  EOF
              shell: bash

            - name: Verify tag matches pyproject version
              run: |
                  TAG_VERSION="${{ github.ref_name }}"
                  PROJECT_VERSION="${{ steps.version.outputs.version }}"
                  EXPECTED_TAG="v${PROJECT_VERSION}"
                  if [ "$TAG_VERSION" != "$EXPECTED_TAG" ]; then
                      echo "Error: Tag version mismatch"
                      echo "  Tag: $TAG_VERSION"
                      echo "  Expected tag (from pyproject.toml): $EXPECTED_TAG"
                      echo "  pyproject.toml version: $PROJECT_VERSION"
                      exit 1
                  fi
                  echo "✓ Tag version matches pyproject.toml version"

            - name: Build package
              run: uv build

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  password: ${{ secrets.PYPI_API_TOKEN }}

            - name: Create or update GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
                  name: Release ${{ steps.version.outputs.version }}
                  body: |
                      ## Release ${{ steps.version.outputs.version }}

                      Published to PyPI: [asgi-http-compression==${{ steps.version.outputs.version }}](https://pypi.org/project/asgi-http-compression/${{ steps.version.outputs.version }}/)

                      Install with:
                      ```bash
                      pip install asgi-http-compression==${{ steps.version.outputs.version }}
                      ```
                  draft: false
                  prerelease: ${{ contains(steps.version.outputs.version, 'a') || contains(steps.version.outputs.version, 'b') || contains(steps.version.outputs.version, 'rc') }}
                  files: dist/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
